"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[95698],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=l(n),g=i,h=u["".concat(p,".").concat(g)]||u[g]||d[g]||r;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=g;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[u]="string"==typeof e?e:i,o[1]=s;for(var l=2;l<r;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},11113:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var a=n(87462),i=(n(67294),n(3905));const r={slug:"save-s3-vpc",title:"Save $ on public S3 buckets using VPC endpoints via SQL",authors:["yrobla","depombo"],date:new Date("2023-03-06T00:00:00.000Z"),tags:["tutorial"]},o=void 0,s={permalink:"/blog/save-s3-vpc",editUrl:"https://github.com/alantech/iasql/tree/main/site/blog/tutorials/optimize-s3-endpoints.mdx",source:"@site/blog/tutorials/optimize-s3-endpoints.mdx",title:"Save $ on public S3 buckets using VPC endpoints via SQL",description:"Are you using S3 buckets as part of your cloud deployments? How are you accessing them?",date:"2023-03-06T00:00:00.000Z",formattedDate:"March 6, 2023",tags:[{label:"tutorial",permalink:"/blog/tags/tutorial"}],readingTime:6.76,hasTruncateMarker:!0,authors:[{name:"Yolanda Robla",imageURL:"https://github.com/yrobla.png",key:"yrobla"},{name:"L. Fernando De Pombo",imageURL:"https://github.com/depombo.png",key:"depombo"}],frontMatter:{slug:"save-s3-vpc",title:"Save $ on public S3 buckets using VPC endpoints via SQL",authors:["yrobla","depombo"],date:"2023-03-06T00:00:00.000Z",tags:["tutorial"]},prevItem:{title:"Deploy Stable Diffusion in EC2 using a SQL query",permalink:"/blog/deploy-stable-diffusion"},nextItem:{title:"Securely connect to an Amazon RDS via PrivateLink using SQL",permalink:"/blog/rds-privatelink"}},p={authorsImageUrls:[void 0,void 0]},l=[{value:"Why use VPC Interface Endpoints",id:"why-use-vpc-interface-endpoints",level:3},{value:"Interface endpoints",id:"interface-endpoints",level:2},{value:"Endpoint gateways",id:"endpoint-gateways",level:2},{value:"Testing the result",id:"testing-the-result",level:2}],c={toc:l},u="wrapper";function d(e){let{components:t,...n}=e;return(0,i.kt)(u,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Are you using S3 buckets as part of your cloud deployments? How are you accessing them?"),(0,i.kt)("p",null,"When running applications behind VPCs without public access, there may be the need to access S3 buckets from the private subnet over the public internet.\nOne simple but costly way to do so is to rely on ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/en_en/vpc/latest/userguide/vpc-nat-gateway.html"},"NAT gateways"),"."),(0,i.kt)("img",{src:"/img/optimize-s3-endpoints/s3_nat_gateway.png",style:{maxWidth:400}}),(0,i.kt)("p",null,"However, creating ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html"},"gateway or interface VPC endpoints")," for each region where your buckets are exposed is a more optimal solution."),(0,i.kt)("img",{src:"/img/optimize-s3-endpoints/s3_privatelink.png",style:{maxWidth:600}}),(0,i.kt)("p",null,"When the VPC endpoints are enabled you can access your S3 buckets using this endpoint. In this post, we will walk you through how to control your buckets from an internal network with the desired security, and without the extra costs of a NAT gateway using a VPC endpoint and IaSQL. IaSQL is an ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/iasql/iasql"},"open-source")," software tool that creates a two-way connection between an unmodified PostgreSQL database and an AWS account so you can manage your infrastructure from a database."),(0,i.kt)("h3",{id:"why-use-vpc-interface-endpoints"},"Why use VPC Interface Endpoints"),(0,i.kt)("p",null,"AWS VPC Interface Endpoints are a component of AWS's ",(0,i.kt)("a",{parentName:"p",href:"https://aws.amazon.com/privatelink"},"PrivateLink")," infrastructure. AWS PrivateLink provides private connectivity between virtual private clouds (VPCs), supported AWS services, and your on-premises networks without exposing your traffic to the public internet."),(0,i.kt)("p",null,"Relying on PrivateLink offers a set of advantages in terms of ",(0,i.kt)("strong",{parentName:"p"},"cost"),", ",(0,i.kt)("strong",{parentName:"p"},"security")," and ",(0,i.kt)("strong",{parentName:"p"},"performance"),"."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Cost")),(0,i.kt)("p",null,"When using NAT gateways, you are paying for the NAT gateway itself, and the bandwidth used to access the internet. A NAT gateway is a generic way for private instances to reach the internet, and can be useful for generic usage, such as pulling dependencies, updating repositories, etc... But when used for reaching AWS resources directly, there are more optimal and cheaper solutions such as VPC endpoints - they will not have generic access to internet but only to specified public AWS endpoints. When using VPC endpoints, you are paying for the bandwidth used to access the public endpoints, but not for the VPC endpoint itself."),(0,i.kt)("p",null,"Costs for NAT gateway depend on each region, but it should be over ",(0,i.kt)("em",{parentName:"p"},"0.045 USD/hour")," per GB processed + ",(0,i.kt)("em",{parentName:"p"},"0.045 USD/hour")," for the instance itself. Costs for VPC endpoints are charged at ",(0,i.kt)("em",{parentName:"p"},"0.01 USD/hour")," per GB processed, being cheaper after the first PB."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Component"),(0,i.kt)("th",{parentName:"tr",align:null},"Hourly pricing"),(0,i.kt)("th",{parentName:"tr",align:null},"Per GB pricing"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"NAT gateway"),(0,i.kt)("td",{parentName:"tr",align:null},"0.045 USD/hour"),(0,i.kt)("td",{parentName:"tr",align:null},"0.45 USD/hour per GB")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"VPC endpoint"),(0,i.kt)("td",{parentName:"tr",align:null},"--"),(0,i.kt)("td",{parentName:"tr",align:null},"0.01 USD/hour per GB")))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Security: no internet traversal")),(0,i.kt)("p",null,"When deploying services in production, the concept of defense-in-depth is essential: have an information assurance strategy that provides multiple, redundant defensive measures in case a security control fails or a vulnerability is exploited.\nBy using interface endpoints the services will be accessed via Amazon's internal networks. It is an essential security measure, that will prevent attackers from directly reaching the services by keeping them in a private network, reducing the surface area of attack."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Security: policies")),(0,i.kt)("p",null,"AWS services can benefit from ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/access_controlling.html"},"IAM policies")," for fine-grained access control. When using interface endpoints, those policies can be applied to determine the traffic that can pass through the interface."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Performance: latency")),(0,i.kt)("p",null,"Because the traffic stays within Amazon\u2019s networks, the physical distance traveled, the number of hops and the risk of traversing congested networks are all significantly lower."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Performance: bandwidth")),(0,i.kt)("p",null,"PrivateLink supports a sustained bandwidth of 10 Gbps per availability zone with bursts up to 40 Gbps."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Performance: stability")),(0,i.kt)("p",null,"PrivateLink consistently lowers the number of errors and timeouts on high loads. The distance traveled, the number of hops, and the risks associated with traversing congested networks are reduced when the traffic over Private Link stays within Amazon\u2019s networks."),(0,i.kt)("p",null,"In terms of speed, Private Link supports a sustained bandwidth of 10 Gbps per availability zone with bursts up to 40 Gbps."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Do you want to know if you have it properly configured? The following query will check for active S3 VPC interface endpoints:")),(0,i.kt)("p",null,"This query will find your active S3 buckets for all regions, associated with the existing endpoint gateways or interfaces - if they exist."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Query for missing endpoints"',title:'"Query',for:!0,missing:!0,'endpoints"':!0}," -- Installing the needed modules\nSELECT\n  iasql_install ('aws_s3', 'aws_vpc');\n\n-- Perform the query for endpoints\nSELECT\n  bucket.region,\n  vpc.is_default,\n  vpc.cidr_block,\n  (\n    SELECT\n      COUNT(*) > 0\n    FROM\n      endpoint_gateway\n    WHERE\n      endpoint_gateway.region = bucket.region\n      AND service = 's3'\n      AND endpoint_gateway.vpc_id = vpc.id\n  ) AS has_endpoint_gateway,\n  (\n    SELECT\n      COUNT(*) > 0\n    FROM\n      endpoint_interface\n    WHERE\n      endpoint_interface.region = bucket.region\n      AND service = 's3'\n      AND endpoint_interface.vpc_id = vpc.id\n  ) AS has_endpoint_interface\nFROM\n  bucket\n  LEFT OUTER JOIN vpc ON vpc.region = bucket.region;\n")),(0,i.kt)("p",null,"Have you found missing endpoints? No problem, IaSQL can generate them for you. You can create two different types of endpoints: gateway and interface. We're going to describe their main features and you can create the desired type in an automated way."),(0,i.kt)("h2",{id:"interface-endpoints"},"Interface endpoints"),(0,i.kt)("p",null,"An interface endpoint is an elastic network interface with a private IP address that serves as an entry point for traffic destined for a supported AWS service. As they use ENIs, they can benefit from security groups to control traffic."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/access_controlling.html"},"IAM policies")," can also be\nadded to control access to those endpoints."),(0,i.kt)("p",null,"They are regional, meaning they can only be accessed by the same region they are created. However, Multi-region is possible by also using VPC peering, so resources in one region can be accessed from others, though this only supports IPv4 TCP traffic."),(0,i.kt)("p",null,"An interface endpoint (except S3 interface endpoint) has a corresponding private DNS hostname, that can be used to access the resource."),(0,i.kt)("p",null,"Interface endpoints cover a wide range of services such as S3, Lambda, API Gateway, etc... ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/vpc/latest/privatelink/create-interface-endpoint.html"},"Get more detail about interface endpoints")),(0,i.kt)("p",null,"This query will auto-generate the missing interface endpoints and will preview the changes to be applied on your cloud. Simply uncomment the final statement and run it to make the changes to your cloud account."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Insert missing endpoints"',title:'"Insert',missing:!0,'endpoints"':!0}," -- Inserts the missing endpoints\nSELECT\n  *\nFROM\n  iasql_begin ();\n\nINSERT INTO\n  endpoint_interface (region, vpc_id, service)\nSELECT\n  bucket.region,\n  vpc.id,\n  's3'\nFROM\n  bucket\n  INNER JOIN vpc ON bucket.region = vpc.region\nWHERE\n  NOT EXISTS (\n    SELECT\n      id\n    FROM\n      endpoint_interface\n    WHERE\n      endpoint_interface.region = bucket.region\n      AND endpoint_interface.vpc_id = vpc.id\n  );\n\n-- Preview the changes\nSELECT\n  *\nFROM\n  iasql_preview ();\n\n-- Commit the changes\n-- SELECT * FROM iasql_commit();\n-- Rollback changes\n-- SELECT * FROM iasql_rollback();\n")),(0,i.kt)("h2",{id:"endpoint-gateways"},"Endpoint gateways"),(0,i.kt)("p",null,"An endpoint gateway is a gateway that can be configured as a target for a route in your route table, used to access traffic in DynamoDB or S3."),(0,i.kt)("p",null,"Multiple gateway endpoints can be created in a single VPC, and those can be used on different route tables to enforce different access policies from different subnets to the same service."),(0,i.kt)("p",null,"Gateway endpoints are supported within the same region only, resources from multiple regions cannot be accessed, even using VPC peering. They also support IPv4 traffic only."),(0,i.kt)("p",null,"To use them, DNS resolution must be enabled in the VPC."),(0,i.kt)("p",null,"When a route is added, all instances in the subnets associated with the route table will automatically use the endpoint to access the service."),(0,i.kt)("p",null,"Gateway endpoints only support S3 and DynamoDB services. ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/vpc/latest/privatelink/gateway-endpoints.html"},"Get more detail about gateway endpoints"),"."),(0,i.kt)("p",null,"This query will auto-generate the missing endpoint gateways and will allow you to preview the changes to be applied on your cloud."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Insert missing Gateway endpoints"',title:'"Insert',missing:!0,Gateway:!0,'endpoints"':!0}," -- Inserts the missing endpoints\nSELECT\n  *\nFROM\n  iasql_begin ();\n\nINSERT INTO\n  endpoint_gateway (region, vpc_id, service)\nSELECT\n  bucket.region,\n  vpc.id,\n  's3'\nFROM\n  bucket\n  INNER JOIN vpc ON bucket.region = vpc.region\nWHERE\n  NOT EXISTS (\n    SELECT\n      id\n    FROM\n      endpoint_gateway\n    WHERE\n      endpoint_gateway.region = bucket.region\n      AND endpoint_gateway.vpc_id = vpc.id\n  )\n  -- Preview the changes\nSELECT\n  *\nFROM\n  iasql_preview ();\n\n-- Commit the changes\n-- SELECT * FROM iasql_commit();\n-- Rollback changes\n-- SELECT * FROM iasql_rollback();\n")),(0,i.kt)("h2",{id:"testing-the-result"},"Testing the result"),(0,i.kt)("p",null,"Once all the relevant endpoints have been created, you can confirm your access to the gateway endpoints from an internal EC2 instance on the same region as the endpoint you want to test:"),(0,i.kt)("img",{src:"/img/optimize-s3-endpoints/ec2_using_vpc.png",style:{maxWidth:500}}),(0,i.kt)("p",null,"For interface endpoints, access also can be tested using the named endpoint:"),(0,i.kt)("img",{src:"/img/optimize-s3-endpoints/s3_via_interface.png"}))}d.isMDXComponent=!0}}]);