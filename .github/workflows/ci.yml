# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

defaults:
  run:
    working-directory: ./engine

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  lint:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # Set up Node.js
      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x

      - name: Install dependencies
        run: yarn

      - name: Run linter check
        run: yarn lint

  cli-style:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # Rust is automatically set up and included by default according to: https://github.com/actions/starter-workflows/blob/master/ci/rust.yml
      # Run cargo fmt linting on the source code
      - name: Run style linter
        run: cd ../cli && cargo fmt -- --check

  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x

      - name: Install dependencies
        run: yarn

      - name: Run tests
        run: yarn test

  docs:
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Check out repo
        uses: actions/checkout@v2
      # Node is required for npm
      - name: Set up Node
        uses: actions/setup-node@v2
        with:
          node-version: "16"
      # Install and build Docusaurus website
      - name: Build Docusaurus website
        run: |
          cd ../docs
          npm install
          npm run build

  db:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # Set up Node.js
      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x

      - name: Install dependencies
        run: yarn

      - name: Docker build and run --detach
        run: |
          echo A0_ENABLED=${A0_ENABLED} >> .env
          echo A0_DOMAIN=${A0_DOMAIN} >> .env
          echo A0_AUDIENCE=${A0_AUDIENCE} >> .env
          echo IRONPLANS_TOKEN=${IRONPLANS_TOKEN} >> .env
          docker-compose up --build --detach
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          IRONPLANS_TOKEN: ${{ secrets.IRONPLANS_TOKEN }}
          AWS_REGION: us-east-1
          A0_ENABLED: true
          A0_DOMAIN: https://auth.iasql.com/
          A0_AUDIENCE: https://api.iasql.com

      - name: Docker ps -a
        run: docker ps -a

      # Waiting for listening port
      - name: Health
        run: while ! curl --output /dev/null --silent --head --fail http://localhost:8088/health; do sleep 1 && echo -n .; done;

      # Check that all migrations are applied
      - name: Add
        run: |
          curl \
          --request POST \
          --url 'http://localhost:8088/v1/db/add/' \
          --show-error --silent --fail \
          --header 'authorization: Bearer ${{ secrets.A0_IASQL_API_TOKEN }}' \
          --header 'content-type: application/json' \
          --data '{
            "dbAlias": "__${{ github.sha }}__",
            "awsRegion": "us-east-1",
            "awsAccessKeyId": "${{ secrets.AWS_ACCESS_KEY_ID }}",
            "awsSecretAccessKey": "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          }'

      - name: Apply
        run: |
          curl -H 'authorization: Bearer ${{ secrets.A0_IASQL_API_TOKEN }}' -f -s -S http://localhost:8088/v1/db/apply/__${{ github.sha }}__

      - name: List
        run: |
          curl -H 'authorization: Bearer ${{ secrets.A0_IASQL_API_TOKEN }}' -f -s -S http://localhost:8088/v1/db/list

      - name: Remove
        run: |
          curl -H 'authorization: Bearer ${{ secrets.A0_IASQL_API_TOKEN }}' -f -s -S http://localhost:8088/v1/db/remove/__${{ github.sha }}__

      - name: Logs engine
        if: always()
        run: docker logs engine_change_engine_1

      - name: Logs psql
        if: always()
        run: docker logs engine_postgresql_1

      - name: Docker stop
        run: docker stop $(docker ps -q)
