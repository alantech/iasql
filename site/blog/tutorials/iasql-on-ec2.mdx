---
slug: iasql-on-ec2
title: Deploy IaSQL on EC2 using IaSQL
authors: [mtp1376]
---

We're intending to publish a series of blog posts on deploying different services using IaSQL. IaSQL covers a wide range of AWS services, so there are lots of possibilities to explore. You can deploy containers to ECS, launch servers using EC2, and have CodePipelines that take the burden of building and deploying your applications.

In this post we'll explore how to deploy IaSQL on EC2, using IaSQL!

### Start IaSQL
To start using IaSQL capabilities, we'll need to run a local version of IaSQL:
```bash
docker run -p 9876:9876 -p 5432:5432 --name iasql iasql/iasql
```
This will download the latest IaSQL image from DockerHub and run it. After it's ready, you can access the dashboard at the following URL:
```
http://localhost:9876/
```
<img src={"/img/dashboard.png"} alt={"IaSQL dashboard"} />

Now you can connect your AWS account in the dashboard. This will create a new database for you which you can connect to it using any Postgres client, or run your queries on it through the dashboard.

If you'd prefer to use a hosted version, and not to run a local version of IaSQL, you can visit [app.iasql.com](https://app.iasql.com/) to use our SaaS solution.

### Deploy IaSQL on EC2 with IaSQL
Let's begin by taking an overview of what we're going to do to give you a general idea of the parts that are going to be deployed, before we move on to explore the specifics.

To deploy IaSQL on EC2, we need to:

- Launch an EC2 instance that will host IaSQL
- Set the EC2 user data so that Docker will be installed upon instance launch, and the IaSQL container will be started
- Import an SSH key pair into AWS to be able to access the EC2 instance afterwards
- Set a security group for the instance to allow SSH, while disallowing unauthorized access to the dashboard

{diagram here}

Let's start by installing the needed IaSQL modules. IaSQL has a modular design, and therefore to manage EC2 instances, we need to use [`aws_ec2` module](https://iasql.com/docs/modules/aws/aws_ec2/. Also, [`aws_ec2_metadata`](https://iasql.com/docs/modules/aws/aws_ec2_metadata/) allows us to get more info on our EC2 instance, like its public IP.
```sql
SELECT * FROM iasql_install('aws_ec2', 'aws_ec2_metadata');
```

If you want to be able to access the instance through SSH, you can import your public key into AWS by executing the following IaSQL RPC:
```sql
SELECT * FROM key_pair_import('iasql', '<your-public-key-content>', 'us-east-1');
```

This will direct IaSQL to create an [AWS key pair](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/create-key-pairs.html#how-to-generate-your-own-key-and-import-it-to-aws) with the name `iasql` in the `us-east-1` region, and with your public key contents.

:::note
An IaSQL RPC is a function defined in Postgres that upon calling, sends a request to the IaSQL engine to run a pre-define logic and returns results to the Postgres console. In the above example [`key_pair_import`](https://iasql.com/docs/modules/aws/tables/aws_ec2_rpcs_import.KeyPairImportRpc/) is an IaSQL RPC that triggers the IaSQL engine to send a request to AWS for importing the public key.
:::

Now it's time to launch our EC2 instance. Before we go for the instance itself, let's first define the security group that's going to be attached to it. For this purpose, we'll need [`aws_security_group`](https://iasql.com/docs/modules/aws/aws_security_group/) module. But since `aws_ec2` module depends on it, it's already installed because IaSQL automatically installs the dependencies for modules upon an `iasql_install` call.

<img src={"/img/module-dependency.png"} alt={"aws_ec2 module dependencies"} />

```sql
INSERT INTO security_group (description, group_name)
VALUES ('IaSQL security group', 'iasql_sg');

INSERT INTO security_group_rule (is_egress, ip_protocol, from_port, to_port, cidr_ipv4, description, security_group_id)
SELECT t.is_egress,
       t.ip_protocol,
       t.from_port,
       t.to_port,
       t.cidr_ipv4::cidr,
       t.description,
       security_group.id
FROM security_group,
     (VALUES (FALSE, 'tcp', 22, 22, '0.0.0.0/0', 'ssh port is accessible from all ips'),
             (FALSE, 'tcp', 9879, 9879, '<your-ip>/0', 'open dashboard to just me'),
             (FALSE, 'tcp', 5432, 5432, '0.0.0.0/0', 'postgres port is accessible from all ips'),
             (TRUE, 'tcp', 1, 65535, '0.0.0.0/0',
              'allow outgoing traffic to anywhere')) AS t (is_egress, ip_protocol, from_port, to_port, cidr_ipv4, description)
WHERE security_group.group_name = 'iasql_sg';
```
The first query simply creates a security group named `iasql_sg`. The second query seems a bit hard at the first sight, but it can be re-written as multiple `INSERT` queries:
```sql
INSERT INTO security_group (is_egress, ip_protocol, from_port, to_port, cidr_ipv4, description, security_group_id)
VALUES (FALSE, 'tcp', 22, 22, '0.0.0.0/0', 'ssh port is accessible from all ips',
        (SELECT id FROM security_group WHERE group_name = 'iasql_sg'));
```
The reason we've written it that way is to avoid repeating the inner `SELECT id FROM security_group` query four times. The `security_group_id` column has an FK set to the `security_group` table's `id` column. Therefore, we need to insert the correct `id` for the security group we just created.

Since the IaSQL dashboard does not have a default authorization mechanism set, remember to replace `<your-ip>` value in the above queries with your own IP address.

:::info
You can find your current IP address by visiting [api.ipify.org](https://api.ipify.org/). Just remember that most internet users don't have a static IP address and your IP address will be changed each time your router reconnects.
:::

