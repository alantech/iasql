---
slug: deploy-static-website
title: Deploy a Static Website Using SQL
date: 2022-12-21
unlisted: true
authors: [mtp1376]
---
Did you know you can deploy a static website without leaving your SQL REPL? In this post we'll show you how to leverage IaSQL's capabilities to simply deploy a static website from your Github repository to AWS using only SQL commands.

## Overview
First, we will create a S3 bucket which will hold our static files. Then we'll enable S3 static website hosting to be able to access our website using a S3 endpoint. We'll also need to enable public access to our S3 files. After that we will create a new CloudFront distribution because S3 static website hosting doesn't support HTTPS, and we're done. Let's dive in to see how IaSQL can deploy a static website using simple SQL commands.

## Create a S3 Bucket
To be able to work with S3, we should first install corresponding IaSQL module.
```sql TheButton[Install S3 Module]="Install S3 Module"
select iasql_install('aws_s3');
```

Now that we have access to `aws_s3` provided tables and RPCs, let's deploy our static website. To do so, first we need to create a S3 bucket.
```sql TheButton[Create a S3 bucket]="Create a S3 Bucket"
SELECT iasql_begin();
INSERT INTO bucket (name, policy_document, region) VALUES ('<bucket-name>', '{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": [
        "s3:GetObject"
      ],
      "Resource": [
        "arn:aws:s3:::<bucket-name>/*"
      ]
    }
  ]
}', 'us-east-1');
SELECT iasql_commit();
```
The above command will direct IaSQL to create a new bucket in the `us-east-1` region with the name `<bucket-name>` and with the given policy. The `iasql_begin` and `iasql_commit` functions are RPCs that will start and finish an IaSQL transaction. For more info on this topic you can read [this doc](https://iasql.com/docs/next/transaction/).

Now that we have a bucket, we can upload a file to it and see if we're able to view it using our web browser. Let's use IaSQL to upload a file to our newly created bucket:
```sql TheButton[Upload a File to Bucket]="Upload a File to S3 Bucket"
SELECT * FROM s3_upload_object('<bucket-name>', 'hello.txt', 'Hello IaSQL!', 'text/plain');
```
This is going to upload a file named `hello.txt` in our bucket whose content is `Hello IaSQL!`.

:::note
You can read the code for [`s3_upload_object` RPC](https://github.com/iasql/iasql-engine/blob/c70f068c7520baf00cea9ddd3a76b8c6dbd2b23b/src/modules/aws_s3/rpcs/s3_upload_object.ts#L27-L33) as well as all other IaSQL modules and RPCs in [our Github repository](https://github.com/iasql/iasql-engine/) to see how they work.
:::

Let's see if we can access our file using the S3 bucket URL. It should be as follows:
```
https://<bucket-name>.s3.amazonaws.com/hello.txt
```
But we're unable to access the file directly because S3 blocks the public access by default.
<img src="/img/s3-access-denied.png" />

So we need to enable public access to our bucket files in order to be able to directly access the files.
```sql TheButton[Enable Public Access to S3 Bucket]="Enable Public Access to The Bucket"
SELECT iasql_begin();
INSERT INTO public_access_block (
    bucket_name, block_public_acls, ignore_public_acls, block_public_policy, restrict_public_buckets
) VALUES (
    '<bucket-name>', false, false, false, false
);
SELECT iasql_commit();
```

Now we should be able to directly access our file through the web browser.
```
https://<bucket-name>.s3.amazonaws.com/hello.txt
```
<img src="/img/hello-iasql.png" />

But simply serving the files doesn't mean we can host a static website. We need to enable [static website hosting](https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteHosting.html) for our bucket to be able to deploy a React codebase. So let's enable it.
```sql TheButton[Enable S3 Static Website Hosting]="Enable S3 Static Website Hosting"
SELECT iasql_begin();
INSERT INTO bucket_website (bucket_name, index_document) VALUES (
    '<bucket-name>', 'index.html'
);
SELECT iasql_commit();
```
So we'll use this functionality to route all the requests to `index.html` file. This way we can deploy a sample React application and serve it through S3.

Now that everything is set, we just need to build our React app and deploy it to S3. We have already pushed a sample app to this repository:
```
https://github.com/iasql/sample-react-app
```
But you can use whatever codebase you'd like by changing the URLs so that they point to your own codebase.

Now it's the time to create a CodeBuild project that does the following:
- Pull the codebase from the Github repository
- Build the app
- Copy the resulting files (`build/*`) to the S3 bucket

To do so, we can run the following SQL command:
```sql TheButton[Create a CodeBuild Project to Build and Deploy S3 Website]="Create a CodeBuild Project to Build and Deploy The Website"
SELECT iasql_begin();
-- create the needed role for codebuild
INSERT INTO iam_role (role_name, assume_role_policy_document, attached_policies_arns) VALUES (
    'deploy-static-website-role', '{"Statement":[{"Effect":"Allow","Principal":{"Service":"codebuild.amazonaws.com"},"Action":"sts:AssumeRole"}],"Version":"2012-10-17"}', array['arn:aws:iam::aws:policy/AWSCodeBuildAdminAccess', 'arn:aws:iam::aws:policy/CloudWatchLogsFullAccess', 'arn:aws:iam::aws:policy/AmazonS3FullAccess']
);
-- create the codebuild project
INSERT INTO codebuild_project (project_name, build_spec, source_type, privileged_mode, service_role_name, region) VALUES (
'deploy-static-website', 'version: 0.2

phases:
  pre_build:
    commands:
      - git clone https://github.com/iasql/sample-react-app && cd sample-react-app
  build:
    commands:
      - echo Installing dependencies
      - npm install
      - echo Building the app
      - npm run build
  post_build:
    commands:
      - echo Copying the files to the S3 bucket
      - aws s3 sync build/ s3://<bucket-name>', 'NO_SOURCE', false, 'deploy-static-website-role', 'us-east-1'
);
SELECT iasql_commit();
```
The above SQL command first creates a role that is needed for CodeBuild to operate. Then it'll create the actual CodeBuild project that clones the repo, builds it and finally syncs the resulting files to our S3 bucket. We need to trigger the CodeBuild project to run and then our files will be uploaded to our bucket.
```sql TheButton[Trigger The CodeBuild Project]="Trigger The CodeBuild Project"
SELECT * FROM start_build('deploy-static-website', 'us-east-1');
```
This will trigger the CodeBuild project to start. After a while we should be able to see the files appearing in our S3 bucket. We can access our React app using the endpoint for the S3 static website hosting. To get the endpoint, we can use `get_bucket_website_endpoint` helper function.
```sql TheButton[Get The Bucket Website Endpoint]="Get The Bucket Website Endpoint"
SELECT get_bucket_website_endpoint('<bucket-name>');
```
By visiting the link returned by the above function, you can see our sample app has been deployed. The problem is that S3 static website hosting does not support HTTPS, and therefore we need to use a CloudFront distribution in order to have HTTPS connection.
